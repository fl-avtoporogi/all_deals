# Быстрый старт: refresh_deals_NEW.php

## Что это?

Оптимизированная версия обновления сделок с ускорением в **4.5-9 раз**.

- **Было**: 9 часов для 50,000 сделок (~92 сделки/мин)
- **Стало**: 1-2 часа для 50,000 сделок (~300-1000 сделок/мин)

## Как запустить?

### Шаг 1: Тестовый запуск (ОБЯЗАТЕЛЬНО!)

```bash
php refresh_deals_NEW.php limit 100
```

Проверьте данные в БД перед полным запуском!

### Шаг 2: Полный запуск

```bash
php refresh_deals_NEW.php
```

### Прервать и продолжить

Можно прервать (Ctrl+C) и продолжить позже:
```bash
php refresh_deals_NEW.php  # Продолжит с последней сделки
```

### Начать заново

```bash
php refresh_deals_NEW.php reset
php refresh_deals_NEW.php
```

## Что делает скрипт?

1. ✅ Загружает справочники (стадии, пользователи, отделы) - **1 раз**
2. ✅ Обрабатывает сделки **пакетами по 50** через batch API
3. ✅ Загружает товары **пакетами** вместо по одному
4. ✅ Записывает в БД **пакетами по 100** записей
5. ✅ Сохраняет прогресс каждые несколько пакетов

## Основные отличия от старой версии

| Что | Старая версия | Новая версия |
|-----|---------------|--------------|
| HTTP запросы | Да (каждая сделка) | Нет |
| API запросов на сделку | 10-50 | 0.02-0.05 |
| Справочники | Каждый раз | 1 раз + кэш |
| БД запросов | 1 на сделку | 1 на 100 сделок |
| Скорость | ~92 сделки/мин | ~300-1000 сделок/мин |

## Вывод скрипта

```
Загрузка справочников...
[CACHE] Получение свежих данных: bonus_codes
Загружено кодов бонусов: 6
[CACHE] Получение свежих данных: stages
Загружено стадий: 45
...

[5000/50000] 10.0% | Пакет: 50 сделок за 5.2s (576/мин) | Всего: 612.3/мин | ETA: 01:13:24
```

## Файлы

- `refresh_deals_NEW.php` - основной скрипт
- `refresh_progress_new.json` - прогресс (создается автоматически)
- `cache/` - кэш справочников (создается автоматически)

## Требования

- PHP 7.4+
- MySQL 5.7+
- CRest (уже настроен в проекте)
- 1GB RAM
- Подключение к интернету

## Безопасность

✅ Использует `ON DUPLICATE KEY UPDATE` - безопасно обновляет существующие записи
✅ Можно прервать в любой момент - прогресс сохраняется
✅ Защита от SQL-injection через prepared statements

## Помощь

Подробная документация: [OPTIMIZATION_GUIDE.md](OPTIMIZATION_GUIDE.md)

## Быстрое сравнение

```bash
# Старый способ (медленный)
php refresh_deals.php
# → ~9 часов для 50k сделок

# Новый способ (быстрый)
php refresh_deals_NEW.php
# → ~1-2 часа для 50k сделок
```

**Экономия времени: ~7 часов!** ⚡
