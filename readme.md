# Инструкция по установке системы расчета бонусов

## Описание системы

Модифицированная система обработки сделок Битрикс24 с автоматическим расчетом бонусов и оборотов по категориям товаров A и B на основе кодов бонусов.

## Требования

- PHP 7.4+
- MySQL 5.7+
- Доступ к API Битрикс24
- Библиотека CRest для работы с Битрикс24

## Установка

### Шаг 1: Подготовка файлов

1. **Создайте файл `bonus_code.csv`** в корневой директории проекта со следующим содержимым:
```csv
Код бонуса;Бонус
A1;35
A2;35
A3;70
A4;70
B5;45
B6;90
```

2. **Разместите файлы на сервере:**
    - `index.php` - основной скрипт обработки
    - `import_bonus_codes.php` - скрипт импорта данных
    - `bonus_code.csv` - файл с кодами бонусов

### Шаг 2: Импорт данных

1. **Запустите скрипт импорта единоразово:**
```bash
php import_bonus_codes.php
```

2. **Проверьте результат:**
    - Скрипт создаст таблицу `bonus_codes`
    - Импортирует данные из CSV
    - Покажет статистику импорта
    - Нормализует коды (защита от кириллицы)

### Шаг 3: Настройка Битрикс24

1. **Настройте бизнес-процесс** для вызова webhook:
```
https://your-domain.com/webhooks/avtoporogi/all_deals/index.php?deal_id={{ID}}
```

2. **Убедитесь, что у товаров заполнено поле "Код бонуса"** (property221)

## Принцип работы

### Алгоритм расчета

1. **Получение данных:**
    - Загружаются данные сделки
    - Получается список товаров сделки
    - Загружается таблица кодов бонусов (с кэшированием)

2. **Обработка каждого товара:**
    - Извлекается код бонуса из поля `property221`
    - Код нормализуется (А,В → A,B)
    - Если код пустой → товар пропускается
    - Определяется категория по первой букве (A или B)

3. **Расчет показателей:**
    - **Оборот** = количество × цена
    - **Бонус** = количество × бонус_за_единицу

### Пример расчета

**Товары в сделке:**
- Товар 1: кол-во=2, цена=1000₽, код="A1" (35₽/шт)
- Товар 2: кол-во=1, цена=500₽, код="B5" (45₽/шт)
- Товар 3: кол-во=3, цена=200₽, код="" (пустой)

**Результат:**
- `turnover_category_a = 2 × 1000 = 2000₽`
- `turnover_category_b = 1 × 500 = 500₽`
- `bonus_category_a = 2 × 35 = 70₽`
- `bonus_category_b = 1 × 45 = 45₽`
- Товар 3 не учитывается (пустой код)

## Структура базы данных

### Таблица `bonus_codes`
```sql
CREATE TABLE bonus_codes (
    code VARCHAR(10) PRIMARY KEY,
    bonus_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### Обновленные поля в таблице `all_deals`
- `date_create` - дата создания сделки
- `closedate` - дата закрытия сделки (NULL для незакрытых сделок)
- `quantity` - общее количество товаров (рассчитанное)
- `turnover_category_a` - оборот по категории A (рассчитанный)
- `turnover_category_b` - оборот по категории B (рассчитанный)
- `bonus_category_a` - бонус по категории A (рассчитанный)
- `bonus_category_b` - бонус по категории B (рассчитанный)

## Кэширование

Система использует два типа кэша с TTL 1 час:

1. **`userfields_cache.json`** - метаданные пользовательских полей
2. **`bonus_codes_cache.json`** - коды бонусов из БД

## Защита от ошибок

### Нормализация кодов
```php
function normalizeBonusCode($code) {
    // Заменяем кириллические А и В на латинские
    $code = str_replace(['А', 'В', 'а', 'в'], ['A', 'B', 'A', 'B'], $code);
    return strtoupper(trim($code));
}
```

### Обработка ошибок
- Пустые коды бонусов → товар пропускается
- Некорректные коды → логирование, товар пропускается
- Ошибки API → остановка выполнения с сообщением
- Ошибки БД → детальное логирование

## Обновление данных

### Обновление кодов бонусов

1. **Отредактируйте файл `bonus_code.csv`**
2. **Запустите импорт повторно:**
```bash
php import_bonus_codes.php
```
3. **Кэш обновится автоматически** при следующем обращении

### Мониторинг работы

Система выводит подробные логи:
- Количество загруженных товаров
- Результаты нормализации кодов
- Расчеты по каждому товару
- Итоговые суммы по категориям
- Ошибки и предупреждения

## Тестирование

**Тестовый запрос:**
```
https://your-domain.com/webhooks/avtoporogi/all_deals/index.php?deal_id=101827
```

**Проверьте в выводе:**
- Успешное подключение к БД
- Загрузку товаров сделки
- Корректность расчетов
- Сохранение в БД

## Возможные проблемы

1. **Товары не загружаются** → проверьте права API
2. **Коды бонусов пустые** → проверьте поле property221
3. **Неверные расчеты** → проверьте таблицу bonus_codes
4. **Ошибки БД** → проверьте подключение и структуру таблиц

## Техническая поддержка

При возникновении проблем проверьте:
- Логи в выводе скрипта
- Наличие файлов кэша
- Содержимое таблицы `bonus_codes`
- Корректность данных в API Битрикс24