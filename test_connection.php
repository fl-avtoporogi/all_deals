<?php
/**
 * Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ”, API Ğ‘Ğ¸Ñ‚Ñ€Ğ¸ĞºÑ24, ĞºÑÑˆ, ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
 *
 * Ğ—Ğ°Ğ¿ÑƒÑĞº: php test_connection.php
 */

error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "\n";
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
echo "â•‘         Ğ¢Ğ•Ğ¡Ğ¢ Ğ“ĞĞ¢ĞĞ’ĞĞĞ¡Ğ¢Ğ˜ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« Ğš ĞĞšĞ¢Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜                â•‘\n";
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

$errors = 0;
$warnings = 0;

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

$requiredFiles = [
    'src/crest.php' => 'Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° CRest',
    '../db_connect.php' => 'ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ”',
    'fast_update_deals.php' => 'ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚',
];

foreach ($requiredFiles as $file => $description) {
    if (file_exists(__DIR__ . '/' . $file)) {
        echo "âœ“ {$description}: {$file}\n";
    } else {
        echo "âœ— {$description}: {$file} - ĞĞ• ĞĞĞ™Ğ”Ğ•Ğ!\n";
        $errors++;
    }
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 2: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ”
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 2: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

try {
    require_once __DIR__ . '/../db_connect.php';

    $mysqli = new mysqli(
        $config['db']['servername'],
        $config['db']['username'],
        $config['db']['password'],
        $config['db']['dbname']
    );

    if ($mysqli->connect_error) {
        echo "âœ— ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ: " . $mysqli->connect_error . "\n";
        $errors++;
    } else {
        echo "âœ“ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾\n";
        echo "  â†’ Ğ¡ĞµÑ€Ğ²ĞµÑ€: {$config['db']['servername']}\n";
        echo "  â†’ Ğ‘Ğ°Ğ·Ğ°: {$config['db']['dbname']}\n";

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
        $charset = $mysqli->character_set_name();
        echo "  â†’ ĞšĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: {$charset}\n";

        if ($charset !== 'utf8mb4') {
            echo "  âš  Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ utf8mb4\n";
            $warnings++;
        }
    }
} catch (Exception $e) {
    echo "âœ— Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ: " . $e->getMessage() . "\n";
    $errors++;
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 3: Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ all_deals
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 3: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ all_deals\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

if (isset($mysqli) && !$mysqli->connect_error) {
    $result = $mysqli->query("DESCRIBE all_deals");

    if ($result) {
        $requiredFields = [
            'deal_id' => 'int',
            'title' => 'varchar',
            'funnel_id' => 'int',
            'stage_id' => 'varchar',
            'date_create' => 'date',
            'closedate' => 'date',
            'opportunity' => 'decimal',
            'quantity' => 'decimal',
            'turnover_category_a' => 'decimal',
            'turnover_category_b' => 'decimal',
            'bonus_category_a' => 'decimal',
            'bonus_category_b' => 'decimal',
        ];

        $existingFields = [];
        while ($row = $result->fetch_assoc()) {
            $existingFields[$row['Field']] = $row['Type'];
        }

        foreach ($requiredFields as $field => $type) {
            if (isset($existingFields[$field])) {
                echo "âœ“ ĞŸĞ¾Ğ»Ğµ {$field} Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚\n";
            } else {
                echo "âœ— ĞŸĞ¾Ğ»Ğµ {$field} ĞĞ¢Ğ¡Ğ£Ğ¢Ğ¡Ğ¢Ğ’Ğ£Ğ•Ğ¢!\n";
                $errors++;
            }
        }

        // Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
        $countResult = $mysqli->query("SELECT COUNT(*) as total FROM all_deals");
        $count = $countResult->fetch_assoc()['total'];
        echo "\n  â†’ Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ: {$count}\n";

        if ($count > 0) {
            $rangeResult = $mysqli->query("SELECT MIN(deal_id) as min_id, MAX(deal_id) as max_id FROM all_deals");
            $range = $rangeResult->fetch_assoc();
            echo "  â†’ Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ ID: {$range['min_id']} - {$range['max_id']}\n";
        }

    } else {
        echo "âœ— Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° all_deals Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!\n";
        $errors++;
    }
} else {
    echo "âŠ˜ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ (Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”)\n";
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 4: Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° bonus_codes
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ bonus_codes\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

if (isset($mysqli) && !$mysqli->connect_error) {
    $result = $mysqli->query("SELECT COUNT(*) as total FROM bonus_codes");

    if ($result) {
        $count = $result->fetch_assoc()['total'];
        echo "âœ“ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° bonus_codes Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°\n";
        echo "  â†’ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ ĞºĞ¾Ğ´Ğ¾Ğ²: {$count}\n";

        if ($count === 0) {
            echo "  âš  Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ! Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: php import_bonus_codes.php\n";
            $warnings++;
        } else {
            // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹
            $samples = $mysqli->query("SELECT code, bonus_amount FROM bonus_codes LIMIT 3");
            echo "  â†’ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ¾Ğ²:\n";
            while ($row = $samples->fetch_assoc()) {
                echo "    â€¢ {$row['code']} = {$row['bonus_amount']} Ñ€ÑƒĞ±.\n";
            }
        }
    } else {
        echo "âœ— Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° bonus_codes Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!\n";
        echo "  â†’ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: php import_bonus_codes.php\n";
        $errors++;
    }
} else {
    echo "âŠ˜ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ (Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”)\n";
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 5: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº API Ğ‘Ğ¸Ñ‚Ñ€Ğ¸ĞºÑ24
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 5: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº API Ğ‘Ğ¸Ñ‚Ñ€Ğ¸ĞºÑ24\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

try {
    require_once __DIR__ . '/src/crest.php';

    // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
    $response = CRest::call('app.info', []);

    if (isset($response['error'])) {
        echo "âœ— ĞÑˆĞ¸Ğ±ĞºĞ° API: {$response['error']}\n";
        echo "  â†’ {$response['error_description']}\n";
        $errors++;
    } elseif (isset($response['result'])) {
        echo "âœ“ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº API Ğ‘Ğ¸Ñ‚Ñ€Ğ¸ĞºÑ24 Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚\n";

        if (isset($response['result']['LICENSE'])) {
            echo "  â†’ Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ: {$response['result']['LICENSE']}\n";
        }

        // Ğ¢ĞµÑÑ‚ batch
        $batchTest = CRest::call('batch', [
            'halt' => 0,
            'cmd' => [
                'test1' => 'app.info',
                'test2' => 'user.current'
            ]
        ]);

        if (isset($batchTest['result']['result'])) {
            echo "âœ“ Batch-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚\n";
        } else {
            echo "âš  Batch-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾\n";
            $warnings++;
        }

    } else {
        echo "âœ— ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ API\n";
        $errors++;
    }

} catch (Exception $e) {
    echo "âœ— Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğº API: " . $e->getMessage() . "\n";
    $errors++;
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 6: ĞšÑÑˆ-Ñ„Ğ°Ğ¹Ğ»Ñ‹
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 6: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºÑÑˆ-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

$cacheFiles = [
    'bonus_codes_cache.json' => 'ĞšÑÑˆ ĞºĞ¾Ğ´Ğ¾Ğ² Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²',
    'userfields_cache.json' => 'ĞšÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹',
];

foreach ($cacheFiles as $file => $description) {
    $fullPath = __DIR__ . '/' . $file;

    if (file_exists($fullPath)) {
        $age = time() - filemtime($fullPath);
        $ageHours = round($age / 3600, 1);

        if ($age < 3600) {
            echo "âœ“ {$description}: Ğ°ĞºÑ‚ÑƒĞ°Ğ»ĞµĞ½ ({$ageHours}Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´)\n";
        } else {
            echo "âš  {$description}: ÑƒÑÑ‚Ğ°Ñ€ĞµĞ» ({$ageHours}Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½)\n";
            $warnings++;
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°
        $size = filesize($fullPath);
        if ($size < 100) {
            echo "  âš  ĞŸĞ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€: {$size} Ğ±Ğ°Ğ¹Ñ‚\n";
            $warnings++;
        }

    } else {
        echo "â€¢ {$description}: Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ (Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)\n";
    }
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 7: ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 7: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

$testFile = __DIR__ . '/test_write_' . time() . '.tmp';

if (file_put_contents($testFile, 'test')) {
    echo "âœ“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ°\n";
    unlink($testFile);
} else {
    echo "âœ— ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²!\n";
    $errors++;
}

if (is_executable(__DIR__ . '/fast_update_deals.php')) {
    echo "âœ“ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¹\n";
} else {
    echo "âš  Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¹ (chmod +x Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ)\n";
    $warnings++;
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 8: PHP Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 8: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PHP Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğ¹\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

$requiredExtensions = [
    'mysqli' => 'Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ MySQL',
    'json' => 'JSON Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°',
    'curl' => 'HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹',
];

foreach ($requiredExtensions as $ext => $description) {
    if (extension_loaded($ext)) {
        echo "âœ“ {$description}: {$ext}\n";
    } else {
        echo "âœ— {$description}: {$ext} - ĞĞ• Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ•ĞĞ!\n";
        $errors++;
    }
}

echo "\n";

// ============================================================================
// Ğ¢Ğ•Ğ¡Ğ¢ 9: Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ PHP
// ============================================================================
echo "ğŸ” Ğ¢Ğ•Ğ¡Ğ¢ 9: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ PHP\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

$memoryLimit = ini_get('memory_limit');
$timeLimit = ini_get('max_execution_time');

echo "  â†’ PHP Ğ²ĞµÑ€ÑĞ¸Ñ: " . PHP_VERSION . "\n";
echo "  â†’ Memory limit: {$memoryLimit}\n";
echo "  â†’ Max execution time: {$timeLimit}";

if ($timeLimit == 0) {
    echo " (Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹)\n";
} else {
    echo " ÑĞµĞº\n";
    if ($timeLimit < 300) {
        echo "  âš  Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ 300+ ÑĞµĞº Ğ¸Ğ»Ğ¸ 0 (Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹)\n";
        $warnings++;
    }
}

echo "\n";

// ============================================================================
// Ğ˜Ğ¢ĞĞ“Ğ˜
// ============================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
echo "Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";

if ($errors === 0 && $warnings === 0) {
    echo "âœ… Ğ’Ğ¡Ğ• Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ«! Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ.\n\n";
    echo "Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³:\n";
    echo "php fast_update_deals.php --limit=10\n\n";
} elseif ($errors === 0) {
    echo "âš ï¸  Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ« Ğ¡ ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ¯ĞœĞ˜\n";
    echo "ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹: {$warnings}\n\n";
    echo "Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ°, Ğ½Ğ¾ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑƒÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ.\n\n";
} else {
    echo "âŒ ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•ĞĞ« ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• ĞĞ¨Ğ˜Ğ‘ĞšĞ˜!\n";
    echo "ĞÑˆĞ¸Ğ±Ğ¾Ğº: {$errors}\n";
    echo "ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹: {$warnings}\n\n";
    echo "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑƒÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.\n\n";
}

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

// Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ
if (isset($mysqli) && !$mysqli->connect_error) {
    $mysqli->close();
}

exit($errors > 0 ? 1 : 0);
